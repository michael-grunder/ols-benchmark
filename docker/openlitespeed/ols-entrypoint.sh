#!/usr/bin/env bash
set -euo pipefail

# Render only the LSAPI vars we care about into a file the wrapper reads
cat > /etc/lsapi.env <<EOF
# generated by ols-entrypoint
${PHP_LSAPI_CHILDREN:+PHP_LSAPI_CHILDREN=${PHP_LSAPI_CHILDREN}}
${LSAPI_MAX_REQUESTS:+LSAPI_MAX_REQUESTS=${LSAPI_MAX_REQUESTS}}
${LSAPI_MAX_PROCESS_TIME:+LSAPI_MAX_PROCESS_TIME=${LSAPI_MAX_PROCESS_TIME}}
${LSAPI_PGRP_MAX_IDLE:+LSAPI_PGRP_MAX_IDLE=${LSAPI_PGRP_MAX_IDLE}}
${LSAPI_AVOID_FORK:+LSAPI_AVOID_FORK=${LSAPI_AVOID_FORK}}
EOF

/usr/local/lsws/bin/lswsctrl start -d
exec tail -F /usr/local/lsws/logs/error.log
